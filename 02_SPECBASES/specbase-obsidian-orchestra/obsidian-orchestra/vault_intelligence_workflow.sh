#!/bin/bash
# VAULT INTELLIGENCE WORKFLOW - Ongoing Optimization System
# Run this monthly to keep your vault optimized

set -e

VAULT_PATH="."
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
OUTPUT_DIR="vault_intelligence_history"

echo "ğŸ§  VAULT INTELLIGENCE WORKFLOW - MONTHLY OPTIMIZATION"
echo "======================================================================="
echo "ğŸ“… Started: $(date)"
echo "ğŸ“ Vault: $VAULT_PATH"
echo

# Create history directory
mkdir -p "$OUTPUT_DIR"

# Step 1: Run complete intelligence analysis
echo "ğŸ” Step 1: Running intelligence analysis..."
python3 obsidian_complete_test.py "$VAULT_PATH"

if [ $? -eq 0 ]; then
    echo "âœ… Intelligence analysis completed"

    # Archive the results
    cp -r obsidian_intelligence_complete "$OUTPUT_DIR/analysis_$TIMESTAMP"
    echo "ğŸ“ Results archived to: $OUTPUT_DIR/analysis_$TIMESTAMP"
else
    echo "âŒ Intelligence analysis failed"
    exit 1
fi

# Step 2: Generate optimization recommendations
echo
echo "ğŸ¯ Step 2: Generating optimization recommendations..."
python3 vault_optimizer.py "$VAULT_PATH"

if [ $? -eq 0 ]; then
    echo "âœ… Optimization recommendations generated"

    # Archive optimization plans
    cp VAULT_OPTIMIZATION_MASTER_PLAN.md "$OUTPUT_DIR/optimization_plan_$TIMESTAMP.md"
    cp BIDIRECTIONAL_LINKS_GUIDE.md "$OUTPUT_DIR/bidirectional_guide_$TIMESTAMP.md" 2>/dev/null || true
    cp ISOLATED_CONTENT_STRATEGY.md "$OUTPUT_DIR/isolated_strategy_$TIMESTAMP.md" 2>/dev/null || true
    cp COMMUNITY_STRENGTHENING_PLAN.md "$OUTPUT_DIR/community_plan_$TIMESTAMP.md" 2>/dev/null || true

    echo "ğŸ“‹ Optimization plans archived"
else
    echo "âŒ Optimization generation failed"
    exit 1
fi

# Step 3: Generate progress report
echo
echo "ğŸ“Š Step 3: Generating progress report..."

REPORT_FILE="$OUTPUT_DIR/progress_report_$TIMESTAMP.md"

cat > "$REPORT_FILE" << EOF
# ğŸ“Š Vault Intelligence Progress Report

**Generated:** $(date)
**Analysis ID:** $TIMESTAMP

## ğŸ“ˆ Current Metrics

EOF

# Extract key metrics from the latest analysis
if [ -f "obsidian_intelligence_complete/complete_intelligence_report.json" ]; then
    python3 -c "
import json

with open('obsidian_intelligence_complete/complete_intelligence_report.json', 'r') as f:
    data = json.load(f)

summary = data['obsidian_intelligence_report']['executive_summary']

print(f'- **Documents:** {summary[\"total_documents\"]:,}')
print(f'- **Connections:** {summary[\"total_connections\"]:,}')
print(f'- **Communities:** {summary[\"communities_detected\"]:,}')
print(f'- **Network Density:** {summary[\"network_density\"]:.4f}')
print(f'- **Avg Connections/Doc:** {summary[\"avg_connections_per_doc\"]:.1f}')
" >> "$REPORT_FILE"
fi

cat >> "$REPORT_FILE" << EOF

## ğŸ† Top Influential Nodes

EOF

# Extract top nodes
if [ -f "obsidian_intelligence_complete/complete_intelligence_report.json" ]; then
    python3 -c "
import json

with open('obsidian_intelligence_complete/complete_intelligence_report.json', 'r') as f:
    data = json.load(f)

top_nodes = data['obsidian_intelligence_report']['network_intelligence']['top_influential_nodes'][:10]

for i, (node, score) in enumerate(top_nodes):
    print(f'{i+1}. **{node}** - Score: {score:.2f}')
" >> "$REPORT_FILE"
fi

cat >> "$REPORT_FILE" << EOF

## ğŸ¯ Recommended Actions

### Phase 1: Quick Wins (1-2 hours)
- [ ] Review and enhance top influential nodes
- [ ] Utilize new index pages created
- [ ] Check navigation improvements

### Phase 2: Structural Improvements (2-4 hours)
- [ ] Implement isolated content connections
- [ ] Strengthen sparse communities
- [ ] Add strategic hub documents

### Phase 3: Relationship Enhancement (4-6 hours)
- [ ] Complete bidirectional links
- [ ] Create topic bridges
- [ ] Optimize knowledge flow

## ğŸ“ Generated Files

- ğŸ” **Intelligence Analysis:** obsidian_intelligence_complete/
- ğŸ¯ **Master Plan:** VAULT_OPTIMIZATION_MASTER_PLAN.md
- ğŸ”— **Bidirectional Guide:** BIDIRECTIONAL_LINKS_GUIDE.md
- ğŸï¸ **Isolation Strategy:** ISOLATED_CONTENT_STRATEGY.md
- ğŸ˜ï¸ **Community Plan:** COMMUNITY_STRENGTHENING_PLAN.md

## ğŸ“Š Historical Data

This analysis is archived in: \`$OUTPUT_DIR/analysis_$TIMESTAMP\`

## ğŸ”„ Next Review

**Recommended:** $(date -d '+1 month' 2>/dev/null || date -v+1m 2>/dev/null || echo 'In 1 month')

---
*Generated by Vault Intelligence Workflow*
*Free alternative to InfraNodus (\$600/year)*
EOF

echo "ğŸ“Š Progress report created: $REPORT_FILE"

# Step 4: Check for improvements since last run
echo
echo "ğŸ“ˆ Step 4: Comparing with previous analysis..."

PREVIOUS_ANALYSIS=$(ls -t "$OUTPUT_DIR"/analysis_* 2>/dev/null | sed -n 2p)

if [ -n "$PREVIOUS_ANALYSIS" ] && [ -f "$PREVIOUS_ANALYSIS/complete_intelligence_report.json" ]; then
    echo "ğŸ“Š Comparing with: $(basename "$PREVIOUS_ANALYSIS")"

    COMPARISON_FILE="$OUTPUT_DIR/comparison_$TIMESTAMP.md"

    python3 -c "
import json
import sys

# Load current analysis
with open('obsidian_intelligence_complete/complete_intelligence_report.json', 'r') as f:
    current = json.load(f)

# Load previous analysis
try:
    with open('$PREVIOUS_ANALYSIS/complete_intelligence_report.json', 'r') as f:
        previous = json.load(f)

    curr_summary = current['obsidian_intelligence_report']['executive_summary']
    prev_summary = previous['obsidian_intelligence_report']['executive_summary']

    print('# ğŸ“ˆ Vault Intelligence Comparison')
    print()
    print('## ğŸ“Š Metric Changes')
    print()

    metrics = [
        ('Documents', 'total_documents'),
        ('Connections', 'total_connections'),
        ('Communities', 'communities_detected'),
        ('Network Density', 'network_density'),
        ('Avg Connections/Doc', 'avg_connections_per_doc')
    ]

    for name, key in metrics:
        curr_val = curr_summary[key]
        prev_val = prev_summary[key]
        change = curr_val - prev_val

        if isinstance(curr_val, float):
            change_str = f'{change:+.4f}'
            curr_str = f'{curr_val:.4f}'
        else:
            change_str = f'{change:+,}'
            curr_str = f'{curr_val:,}'

        emoji = 'ğŸ“ˆ' if change > 0 else 'ğŸ“‰' if change < 0 else 'â¡ï¸'
        print(f'- **{name}:** {curr_str} ({change_str}) {emoji}')

    print()
    print('## ğŸ¯ Improvement Summary')

    total_change = curr_summary['total_connections'] - prev_summary['total_connections']
    density_change = curr_summary['network_density'] - prev_summary['network_density']

    if total_change > 0:
        print(f'âœ… **Network Growth:** +{total_change:,} new connections discovered')

    if density_change > 0:
        print(f'âœ… **Density Improvement:** +{density_change:.4f} better connectivity')

    if total_change > 0 or density_change > 0:
        print('ğŸ‰ **Your vault is getting smarter!**')
    else:
        print('ğŸ“Š **Network stability maintained**')

except Exception as e:
    print(f'âš ï¸  Could not compare with previous analysis: {e}')
" > "$COMPARISON_FILE"

    echo "ğŸ“ˆ Comparison report created: $COMPARISON_FILE"
else
    echo "ğŸ“Š No previous analysis found for comparison"
fi

# Step 5: Create dashboard update
echo
echo "ğŸ¨ Step 5: Updating intelligence dashboard..."

# Update the dashboard with latest metrics
cp vault_intelligence_dashboard.html "$OUTPUT_DIR/dashboard_$TIMESTAMP.html"

echo "ğŸ¨ Dashboard archived: $OUTPUT_DIR/dashboard_$TIMESTAMP.html"

# Final summary
echo
echo "ğŸ‰ WORKFLOW COMPLETE!"
echo "======================================================================="
echo "ğŸ“Š Analysis ID: $TIMESTAMP"
echo "ğŸ“ All results archived in: $OUTPUT_DIR/"
echo "ğŸ¯ Next steps: Review VAULT_OPTIMIZATION_MASTER_PLAN.md"
echo "ğŸ”„ Next run: Recommended in 1 month"
echo
echo "ğŸ“‹ Quick Actions:"
echo "1. Open vault_intelligence_dashboard.html in browser"
echo "2. Review $REPORT_FILE"
echo "3. Implement Phase 1 quick wins from master plan"
echo
echo "ğŸš€ Your vault intelligence is continuously evolving!"
echo "ğŸ’° Saving \$600/year vs InfraNodus with enhanced features!"
EOF