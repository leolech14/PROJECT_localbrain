{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://localbrain.dev/schemas/scene-diff.schema.json",
  "title": "Scene Diff Schema",
  "description": "Schema for describing changes to UI scenes/components in LocalBrain",
  "type": "object",
  "properties": {
    "id": {
      "type": "string",
      "description": "Unique identifier for this diff operation",
      "pattern": "^[a-zA-Z0-9_-]+$"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp when the diff was created"
    },
    "agentId": {
      "type": "string",
      "description": "ID of the agent creating this diff",
      "pattern": "^[A-D]$"
    },
    "sessionId": {
      "type": "string",
      "description": "Session identifier for tracking related operations",
      "pattern": "^[a-zA-Z0-9_-]+$"
    },
    "version": {
      "type": "string",
      "description": "Schema version",
      "default": "1.0.0"
    },
    "operations": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "type": {
            "type": "string",
            "enum": [
              "CREATE_COMPONENT",
              "UPDATE_COMPONENT",
              "DELETE_COMPONENT",
              "MOVE_COMPONENT",
              "RESIZE_COMPONENT",
              "RENAME_COMPONENT",
              "CHANGE_PROPERTY",
              "ADD_CHILD",
              "REMOVE_CHILD",
              "REORDER_CHILDREN"
            ],
            "description": "Type of operation being performed"
          },
          "target": {
            "type": "object",
            "properties": {
              "componentId": {
                "type": "string",
                "description": "ID of the target component"
              },
              "selector": {
                "type": "string",
                "description": "CSS selector for finding the target"
              },
              "path": {
                "type": "string",
                "description": "JSON path to the target within component tree"
              }
            },
            "required": ["componentId"],
            "additionalProperties": false
          },
          "data": {
            "type": "object",
            "description": "Operation-specific data",
            "oneOf": [
              {
                "title": "Create Component",
                "properties": {
                  "componentType": {
                    "type": "string",
                    "description": "Type of component to create"
                  },
                  "parentId": {
                    "type": "string",
                    "description": "ID of parent component"
                  },
                  "initialProps": {
                    "type": "object",
                    "description": "Initial properties for the component"
                  },
                  "position": {
                    "type": "object",
                    "properties": {
                      "x": {"type": "number"},
                      "y": {"type": "number"},
                      "z": {"type": "integer"}
                    }
                  }
                },
                "required": ["componentType", "parentId"]
              },
              {
                "title": "Update Component",
                "properties": {
                  "properties": {
                    "type": "object",
                    "description": "Properties to update"
                  },
                  "style": {
                    "type": "object",
                    "description": "CSS styles to apply"
                  }
                }
              },
              {
                "title": "Delete Component",
                "properties": {
                  "cascade": {
                    "type": "boolean",
                    "description": "Whether to delete child components",
                    "default": true
                  }
                }
              },
              {
                "title": "Move Component",
                "properties": {
                  "newParentId": {
                    "type": "string",
                    "description": "ID of new parent component"
                  },
                  "position": {
                    "type": "object",
                    "properties": {
                      "x": {"type": "number"},
                      "y": {"type": "number"},
                      "z": {"type": "integer"}
                    }
                  },
                  "index": {
                    "type": "integer",
                    "description": "New index among siblings"
                  }
                },
                "required": ["newParentId"]
              },
              {
                "title": "Resize Component",
                "properties": {
                  "width": {
                    "type": "number",
                    "minimum": 0,
                    "description": "New width in pixels"
                  },
                  "height": {
                    "type": "number",
                    "minimum": 0,
                    "description": "New height in pixels"
                  },
                  "constraints": {
                    "type": "object",
                    "properties": {
                      "minWidth": {"type": "number", "minimum": 0},
                      "maxWidth": {"type": "number", "minimum": 0},
                      "minHeight": {"type": "number", "minimum": 0},
                      "maxHeight": {"type": "number", "minimum": 0},
                      "maintainAspectRatio": {"type": "boolean"}
                    }
                  }
                },
                "required": ["width", "height"]
              },
              {
                "title": "Change Property",
                "properties": {
                  "property": {
                    "type": "string",
                    "description": "Property name to change"
                  },
                  "value": {
                    "description": "New property value"
                  },
                  "oldValue": {
                    "description": "Previous property value"
                  }
                },
                "required": ["property", "value"]
              }
            ]
          },
          "metadata": {
            "type": "object",
            "properties": {
              "description": {
                "type": "string",
                "description": "Human-readable description of the operation"
              },
              "reason": {
                "type": "string",
                "description": "Why this operation was performed"
              },
              "conflict": {
                "type": "object",
                "properties": {
                  "type": {
                    "type": "string",
                    "enum": ["CONFLICT", "MERGE", "OVERRIDE", "ABORT"]
                  },
                  "details": {
                    "type": "string",
                    "description": "Details about the conflict"
                  }
                }
              }
            }
          }
        },
        "required": ["type", "target", "data"],
        "additionalProperties": false
      }
    }
  },
  "required": ["id", "timestamp", "agentId", "operations"],
  "additionalProperties": false
}